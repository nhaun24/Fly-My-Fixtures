<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Fly My Fixtures</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="ui_main.css">
</head>
<body>
  <h1>Fly My Fixtures</h1>
  <p>
    <span class="switch"><span>Status:</span><span id="status-pill" class="pill off"></span><small id="status-text">Idle</small></span>
    <span class="switch"><span>Health:</span><span id="health-pill" class="pill off"></span><small id="health-text">Unknown</small></span>
  </p>

  <div class="tabbar" role="tablist">
    <button type="button" class="tab-btn active" data-tab="dashboard">Dashboard</button>
    <button type="button" class="tab-btn" data-tab="settings">Settings</button>
  </div>

  <section class="tab-panel active" data-tab="dashboard">
    <div class="panel-grid">
      <div class="card wide">
        <h3>Controls</h3>
        <div class="switch">
          <button class="btn primary" onclick="activate()">Activate</button>
          <button class="btn danger" onclick="release()">Release</button>
        </div>
        <p class="small muted">Joystick: <span id="joy-name">-</span> • Axes: <span id="joy-axes">0</span> • Buttons: <span id="joy-buttons">0</span></p>
        <p class="small muted">Last frame: <span id="last-frame">-</span></p>
      </div>

      <div class="card wide">
        <h3>Virtual LEDs</h3>
        <div class="led-bank split">
          <div class="led-row">
            <div class="led">
              <div class="led-bulb green" id="led-power"></div>
              <span class="led-label">Power</span>
            </div>
            <div class="led">
              <div class="led-bulb red" id="led-error"></div>
              <span class="led-label">Error</span>
            </div>
          </div>
          <div class="led-row" id="fixture-led-bank">
            <div class="led" data-index="0">
              <div class="led-bulb red" id="fx-led-0"></div>
              <span class="led-label" id="fx-label-0">Slot 1</span>
            </div>
            <div class="led" data-index="1">
              <div class="led-bulb red" id="fx-led-1"></div>
              <span class="led-label" id="fx-label-1">Slot 2</span>
            </div>
            <div class="led" data-index="2">
              <div class="led-bulb red" id="fx-led-2"></div>
              <span class="led-label" id="fx-label-2">Slot 3</span>
            </div>
            <div class="led" data-index="3">
              <div class="led-bulb red" id="fx-led-3"></div>
              <span class="led-label" id="fx-label-3">Slot 4</span>
            </div>
            <div class="led" data-index="4">
              <div class="led-bulb red" id="fx-led-4"></div>
              <span class="led-label" id="fx-label-4">Slot 5</span>
            </div>
            <div class="led" data-index="5">
              <div class="led-bulb red" id="fx-led-5"></div>
              <span class="led-label" id="fx-label-5">Slot 6</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card wide">
        <h3>Virtual HOTAS</h3>
        <div class="switch">
          <label for="vjoy-en">Enable</label>
          <input type="checkbox" id="vjoy-en" onchange="vjoyEnable(this.checked)">
          <small class="muted">Use this when hardware isn’t connected</small>
        </div>

        <div class="virtual-layout">
          <div class="virtual-pad">
            <div id="pad" style="position:relative;width:220px;height:220px;border:1px solid #374151;border-radius:12px;background:radial-gradient(circle at center, #1a1d25, #0f141e);">
              <div id="pad-dot" style="position:absolute;width:18px;height:18px;border-radius:999px;border:2px solid #60a5fa;transform:translate(-50%,-50%);left:110px;top:110px;background:#0f1115"></div>
            </div>
            <div class="switch" style="justify-content:space-between;margin-top:6px">
              <small class="muted">X: <span id="vx">0.00</span>  Y: <span id="vy">0.00</span></small>
            </div>
          </div>

          <div class="virtual-controls">
            <label>Dimmer</label>
            <input type="range" id="vth" min="0" max="100" value="0" oninput="vjoyThrottle(this.value)" />
            <small class="muted">When “Virtual Throttle Invert” is True: 0% = full (axis -1), 100% = empty (axis +1)</small>

            <div style="margin-top:12px">
              <label>Zoom Rocker</label>
              <input type="range" id="vzoom" min="-100" max="100" value="0" oninput="vjoyZoom(this.value)" />
              <small class="muted">Center = hold; push ± to adjust zoom (latches when released)</small>
            </div>

            <div style="margin-top:12px">
              <div class="switch" style="gap:8px;flex-wrap:wrap">
                <button class="btn" onpointerdown="vpress(BTN_ACTIVATE)" onpointerup="vrelease(BTN_ACTIVATE)">Activate</button>
                <button class="btn danger" onpointerdown="vpress(BTN_RELEASE)" onpointerup="vrelease(BTN_RELEASE)">Release</button>
                <button class="btn" onpointerdown="vpress(BTN_FLASH10)" onpointerup="vrelease(BTN_FLASH10)">Flash 10%</button>
                <button class="btn" onpointerdown="vpress(BTN_DIMOFF)" onpointerup="vrelease(BTN_DIMOFF)">Blackout</button>
                <button class="btn" onpointerdown="vpress(BTN_FINE)" onpointerup="vrelease(BTN_FINE)">Fine</button>
                <button class="btn" onpointerdown="vpress(BTN_ZOOM)" onpointerup="vrelease(BTN_ZOOM)">Zoom Mod</button>
              </div>
              <small class="muted">If AX Zoom is set, “Zoom Mod” is ignored (rocker controls zoom incrementally).</small>
            </div>
          </div>
        </div>
      </div>

      <div class="card wide preset-card">
        <h3>Position Presets</h3>
        <p class="small muted">Capture the current pan, tilt, dimmer, and zoom values, then recall them from the web UI or a configured joystick button.</p>

        <div class="preset-current">
          <div class="preset-current-values">
            <span>Pan: <strong id="preset-cur-pan">-</strong></span>
            <span>Tilt: <strong id="preset-cur-tilt">-</strong></span>
            <span>Dimmer: <strong id="preset-cur-dimmer">-</strong></span>
            <span>Zoom: <strong id="preset-cur-zoom">-</strong></span>
          </div>
          <div class="preset-current-actions">
            <input type="text" id="preset-name-input" placeholder="Preset name">
            <div class="preset-current-buttons">
              <button class="btn" type="button" onclick="savePresetFromCurrent()">Save Preset</button>
              <button class="btn" type="button" onclick="refreshPresetState()">Refresh Values</button>
            </div>
          </div>
        </div>

        <p id="preset-status" class="status-line info"></p>

        <div id="preset-list"></div>
      </div>

      <div class="card wide">
        <h3>Packet Capture</h3>
        <label for="pcap-interface">Interface</label>
        <select id="pcap-interface" disabled>
          <option value="">Loading…</option>
        </select>
        <small class="muted" id="pcap-interface-hint">Captures UDP 5568 traffic (sACN). Requires tcpdump with sufficient privileges.</small>
        <p class="small muted" id="pcap-no-ifaces" style="display:none;margin-top:4px;">No network adapters detected.</p>
        <div class="switch" style="margin-top:12px">
          <button class="btn" id="pcap-start" onclick="startPacketCapture()">Start Capture</button>
          <button class="btn danger" id="pcap-stop" onclick="stopPacketCapture()" disabled>Stop</button>
          <a class="btn" id="pcap-download" href="#" style="display:none">Download PCAP</a>
        </div>
        <p class="small muted" id="pcap-status">Idle</p>
        <p class="small" id="pcap-error" style="display:none;background:#4c1d1d;color:#fecaca;padding:6px 10px;border-radius:8px;margin-top:4px;"></p>
      </div>

      <div class="card wide">
        <h3>Logs</h3>
        <textarea id="logs" readonly></textarea>
      </div>
    </div>
  </section>

  <section class="tab-panel" data-tab="settings">
    <div class="panel-grid">
      <div class="card wide">
        <h3>Settings</h3>
        <form id="settings-form" onsubmit="saveSettings();return false;">

          <!-- sACN / Output -->
          <details class="section" open>
            <summary>Output (sACN)</summary>
            <div class="inner">
              <div class="grid">
                <div><label>Priority</label><input type="number" name="priority"></div>
                <div><label>FPS</label><input type="number" name="fps"></div>
                <div><label>Default Universe</label><input type="number" name="default_universe"></div>
                <div class="cbrow"><input type="checkbox" id="per_address_priority_enabled" name="per_address_priority_enabled"><label for="per_address_priority_enabled">Enable Per-Address Priority</label></div>
                <small class="muted" style="grid-column:1 / -1;">When enabled, only patched channels use the configured priority. Disable to send a uniform frame priority.</small>
                <div style="grid-column:1 / -1">
                  <label>Network Adapters</label>
                  <div id="sacn-iface-list" class="checklist">
                    <p class="small muted" id="sacn-iface-loading">Loading adapters…</p>
                  </div>
                  <input type="hidden" name="sacn_bind_addresses" id="sacn_bind_addresses">
                  <small class="muted">Select adapters for sACN output. Leave empty to let the OS choose routing.</small>
                </div>
              </div>
            </div>
          </details>

          <!-- USB Device -->
          <details class="section" open>
            <summary>USB Device</summary>
            <div class="inner">
              <div class="grid">
                <div style="grid-column:1 / -1">
                  <label for="usb_device">USB Device</label>
                  <div class="switch" style="align-items:flex-end;gap:8px;flex-wrap:wrap;">
                    <select name="usb_device" id="usb_device">
                      <option value="">Loading…</option>
                    </select>
                    <button class="btn" type="button" id="usb-refresh-btn" onclick="refreshUsbDevices()">Refresh</button>
                  </div>
                  <small class="muted">Choose which USB joystick/device to use. Leave blank to auto-select the first detected device.</small>
                  <p class="small muted" id="usb-device-empty" style="display:none;margin-top:4px;">No USB devices detected.</p>
                </div>
              </div>
            </div>
          </details>

          <!-- Input mapping -->
          <details class="section" open>
            <summary>Input Mapping (Axes &amp; Buttons)</summary>
            <div class="inner">
              <div class="grid">
                <div><label>AX Pan</label><input type="number" name="ax_pan"></div>
                <div><label>AX Tilt</label><input type="number" name="ax_tilt"></div>
                <div><label>AX Throttle</label><input type="number" name="ax_throt"></div>
                <div><label>AX Zoom</label><input type="number" name="ax_zoom" placeholder="-1 to disable"></div>

                <div><label>BTN Activate</label><input type="number" name="btn_activate"></div>
                <div><label>BTN Release</label><input type="number" name="btn_release"></div>
                <div><label>BTN Flash10</label><input type="number" name="btn_flash10"></div>
                <div><label>BTN Dim Off</label><input type="number" name="btn_dim_off"></div>
                <div><label>BTN Fine</label><input type="number" name="btn_fine"></div>
                <div><label>BTN Zoom Mod</label><input type="number" name="btn_zoom_mod"></div>
              </div>
            </div>
          </details>

          <details class="section">
            <summary>Button → Fixture Actions</summary>
            <div class="inner">
              <p class="small muted">Define joystick button mappings (JSON).
              Supported <code>type</code> values: <b>toggle_fixture</b>, <b>enable_fixture</b>, <b>disable_fixture</b>, <b>toggle_group</b>.
              Optional <code>"mode":"hold"</code> for momentary press.</p>

              <textarea name="button_actions" id="button_actions"></textarea>

              <pre style="white-space:pre-wrap;background:#0b1020;border:1px solid #374151;border-radius:8px;padding:8px;margin-top:6px">
Example:
[
  {"button":7, "type":"toggle_fixture", "targets":["Left"]},
  {"button":8, "type":"toggle_fixture", "targets":["Right"]},
  {"button":9, "type":"toggle_group",   "targets":["Left","Right"]},
  {"button":10,"type":"enable_fixture", "targets":["Left","Right"], "mode":"hold"}
]
              </pre>
            </div>
          </details>

          <!-- Motion / Behavior -->
          <details class="section" open>
            <summary>Movement &amp; Behavior</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="invert_pan" name="invert_pan"><label for="invert_pan">Invert Pan</label></div>
                <div class="cbrow"><input type="checkbox" id="invert_tilt" name="invert_tilt"><label for="invert_tilt">Invert Tilt</label></div>
                <div class="cbrow"><input type="checkbox" id="throttle_invert" name="throttle_invert"><label for="throttle_invert">Throttle Invert</label></div>

                <div><label>Deadband</label><input type="text" name="deadband"></div>
                <div><label>Expo</label><input type="text" name="expo"></div>
                <div><label>Speed</label><input type="number" name="speed"></div>

                <div><label>Pan Min</label><input type="number" name="pan_min"></div>
                <div><label>Pan Max</label><input type="number" name="pan_max"></div>
                <div><label>Tilt Min</label><input type="number" name="tilt_min"></div>
                <div><label>Tilt Max</label><input type="number" name="tilt_max"></div>

                <div><label>Fine Divisor</label><input type="number" name="fine_divisor"></div>
                <div><label>Flash10 Level</label><input type="number" name="flash10_level"></div>
              </div>
            </div>
          </details>

          <!-- Zoom Axis -->
          <details class="section">
            <summary>Zoom Axis (Rocker)</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="zoom_invert" name="zoom_invert"><label for="zoom_invert">Zoom Invert</label></div>
                <div><label>Zoom Deadband</label><input type="text" name="zoom_deadband" placeholder="0.0–0.2"></div>
                <div><label>Zoom Expo</label><input type="text" name="zoom_expo" placeholder="0.0–1.0"></div>
                <div><label>Zoom Speed</label><input type="number" name="zoom_speed" placeholder="e.g. 3000"></div>
              </div>
              <small class="muted">If AX Zoom ≥ 0, the rocker adjusts zoom incrementally and the value latches when released. “Zoom Mod” is ignored.</small>
            </div>
          </details>

          <!-- GPIO LEDs -->
          <details class="section">
            <summary>GPIO LEDs (Raspberry Pi)</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="gpio_enabled" name="gpio_enabled"><label for="gpio_enabled">Enable GPIO LEDs</label></div>
                <div><label>GPIO Green Pin</label><input type="number" name="gpio_green_pin"></div>
                <div><label>GPIO Red Pin</label><input type="number" name="gpio_red_pin"></div>
                <div class="cbrow"><input type="checkbox" id="gpio_active_low" name="gpio_active_low"><label for="gpio_active_low">Active Low</label></div>
                <div><label>Fixture LED Pins (max 6)</label><input type="text" name="gpio_fixture_led_pins" placeholder="e.g. 5,6,13,19,26,12"></div>
                <small class="muted" style="grid-column: 1 / -1;">Enter BCM pin numbers, comma-separated. LEDs light when fixtures are enabled.</small>
              </div>
            </div>
          </details>

          <!-- Virtual Joystick -->
          <details class="section">
            <summary>Virtual Joystick</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="virtual_joystick_enabled" name="virtual_joystick_enabled"><label for="virtual_joystick_enabled">Enable Virtual HOTAS</label></div>
                <div class="cbrow"><input type="checkbox" id="virtual_throttle_invert" name="virtual_throttle_invert"><label for="virtual_throttle_invert">Virtual Throttle Invert</label></div>
              </div>
            </div>
          </details>

          <!-- Debug -->
          <details class="section">
            <summary>Debug Logging</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="debug_log_sacn" name="debug_log_sacn"><label for="debug_log_sacn">Log sACN Frames</label></div>
                <div class="cbrow"><input type="checkbox" id="debug_controller_buttons" name="debug_controller_buttons"><label for="debug_controller_buttons">Controller Button Debug</label></div>
                <div><label>Debug Interval (ms)</label><input type="number" name="debug_log_interval_ms"></div>
                <div class="cbrow"><input type="checkbox" id="debug_log_only_changes" name="debug_log_only_changes"><label for="debug_log_only_changes">Only Log Changes</label></div>
                <div>
                  <label for="debug_log_mode">Debug Mode</label>
                  <select name="debug_log_mode" id="debug_log_mode">
                    <option value="summary">Summary</option>
                    <option value="nonzero">Nonzero</option>
                    <option value="full">Full</option>
                  </select>
                </div>
                <div><label>Nonzero Limit</label><input type="number" name="debug_log_nonzero_limit"></div>
              </div>
            </div>
          </details>

          <div class="form-actions">
            <button class="btn primary" type="submit">Save Settings</button>
            <button class="btn danger" type="button" id="restart-btn" onclick="restartService(this)">Restart Service</button>
          </div>
        </form>
      </div>

      <div class="card wide">
        <h3>Fixtures</h3>
        <div class="switch">
          <label for="multi-universe">Multi-Universe Mode</label>
          <input type="checkbox" id="multi-universe" onchange="toggleMU()">
          <span class="small muted">When off, all fixtures use Default Universe</span>
        </div>

        <div id="fixture-list"></div>

        <div class="subcard">
          <h4>Add Fixture</h4>
          <form id="fx-form" onsubmit="addFixture();return false;">
            <div class="fxgrid">
              <div><label>ID</label><input type="text" name="id" required></div>
              <div class="cbrow"><input type="checkbox" id="fx_enabled" checked><label for="fx_enabled">Enabled</label></div>
              <div><label>Universe</label><input type="number" name="universe"></div>
              <div><label>Start Addr (info)</label><input type="number" name="start_addr"></div>

              <div><label>Pan Coarse</label><input type="number" name="pan_coarse"></div>
              <div><label>Pan Fine</label><input type="number" name="pan_fine"></div>
              <div><label>Tilt Coarse</label><input type="number" name="tilt_coarse"></div>
              <div><label>Tilt Fine</label><input type="number" name="tilt_fine"></div>

              <div><label>Dimmer</label><input type="number" name="dimmer"></div>
              <div><label>Zoom</label><input type="number" name="zoom"></div>
              <div><label>Zoom Fine</label><input type="number" name="zoom_fine"></div>

              <div><label>Color Temp Channel (DMX 11)</label><input type="number" name="color_temp_channel" value="11"></div>
              <div><label>Color Temp Value</label><input type="number" name="color_temp_value" value="0" min="0" max="255"></div>

              <div><label>Pan Bias</label><input type="number" name="pan_bias" value="0"></div>
              <div><label>Tilt Bias</label><input type="number" name="tilt_bias" value="0"></div>

              <div><label>Status LED (1-6)</label><input type="number" name="status_led" min="0" max="6" placeholder="1-6"></div>
              <div style="grid-column:1/-1"><small class="muted">Leave blank or 0 to disable the status LED mapping.</small></div>

              <div class="cbrow"><input type="checkbox" id="fx_invert_pan"><label for="fx_invert_pan">Invert Pan</label></div>
              <div class="cbrow"><input type="checkbox" id="fx_invert_tilt"><label for="fx_invert_tilt">Invert Tilt</label></div>
            </div>

            <!-- hidden compat fields sent to backend -->
            <input type="hidden" name="enabled" id="fx_enabled_hidden" value="True">
            <input type="hidden" name="invert_pan" id="fx_invert_pan_hidden" value="False">
            <input type="hidden" name="invert_tilt" id="fx_invert_tilt_hidden" value="False">

            <div class="form-actions">
              <p id="fixture-limit-msg" class="small muted" style="margin:0 0 0.5rem 0;"></p>
              <button class="btn primary" type="submit" id="fx-add-btn">Add Fixture</button>
            </div>
          </form>
        </div>

        <div class="subcard">
          <h4>Import &amp; Export</h4>
          <div class="form-actions">
            <a class="btn" href="/api/fixtures/export" target="_blank">Export CSV</a>
            <button class="btn" type="button" onclick="showImport()">Import CSV</button>
          </div>
          <div id="import-area" style="display:none">
            <textarea id="csvtext" placeholder="Paste CSV here..."></textarea>
            <div class="form-actions">
              <button class="btn primary" type="button" onclick="doImport()">Import</button>
              <button class="btn danger" type="button" onclick="hideImport()">Cancel</button>
            </div>
            <p class="small muted">Columns: id,enabled,universe,start_addr,pan_coarse,pan_fine,tilt_coarse,tilt_fine,dimmer,zoom,zoom_fine,color_temp_channel,color_temp_value,invert_pan,invert_tilt,pan_bias,tilt_bias,status_led</p>
          </div>
        </div>
      </div>
    </div>
  </section>

<script src="ui_main.js" defer></script>
</body></html>
