<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Fly My Fixtures</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
 :root{color-scheme:dark}
 *,*::before,*::after{box-sizing:border-box}
 body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Arial,sans-serif;max-width:1100px;margin:24px auto;padding:0 12px;background:#0f1115;color:#e5e7eb;line-height:1.45}
 h1{margin-bottom:6px}
 h3{margin:0 0 12px}
 h4{margin:8px 0 12px}
 .panel-grid{display:flex;gap:16px;flex-wrap:wrap}
 .card{flex:1 1 320px;border:1px solid #2f3541;border-radius:14px;padding:20px;background:#111827;box-shadow:0 4px 16px rgba(8,10,20,.35)}
 .card.wide{flex-basis:100%}
 label{display:block;font-size:14px;font-weight:600;color:#f3f4f6}
 .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px;align-items:start}
 .grid > div{display:flex;flex-direction:column;gap:6px;padding:14px;border-radius:12px;background:#0f141d;border:1px solid #2b3140}
 .grid > .cbrow{flex-direction:row;align-items:center;gap:10px;margin-top:0;padding:14px}
 .grid > .cbrow label{margin:0}
 .checklist{display:flex;flex-direction:column;gap:10px;margin-top:6px}
 .checklist-option{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:10px;background:#101826;border:1px solid #2b3140}
 .checklist-option input{margin-top:4px}
 .checklist-text{display:flex;flex-direction:column;gap:4px}
 .checklist-title{font-weight:600;font-size:14px;color:#f3f4f6}
 input[type=number],input[type=text],select{width:100%;padding:10px 12px;border:1px solid #303845;border-radius:10px;background:#1a1d25;color:#e5e7eb;font-size:14px;transition:border-color .15s ease,box-shadow .15s ease}
 input[type=number]:focus,input[type=text]:focus,select:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.25)}
 input[type=checkbox]{width:auto;height:auto;accent-color:#2563eb}
 input[type=range]{width:100%}
 textarea{width:100%;min-height:220px;border:1px solid #303845;border-radius:12px;padding:12px;background:#0b1020;color:#dfe7ff;font-family:ui-monospace,Consolas,monospace;font-size:14px}
 textarea:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.25)}
 .cbrow{display:flex;gap:8px;align-items:center;margin-top:6px;font-weight:500}
 .btn{padding:10px 16px;border-radius:10px;border:1px solid #4b5563;background:#1f2937;color:#e5e7eb;cursor:pointer;font-weight:600;transition:background .15s ease,border-color .15s ease,transform .1s ease}
 .btn:hover{background:#273244}
 .btn:active{transform:scale(.98)}
 .btn.primary{background:#2563eb;border-color:#2563eb}
 .btn.primary:hover{background:#1e4fc7}
 .btn.danger{background:#dc2626;border-color:#dc2626}
 .btn.danger:hover{background:#b91c1c}
 .tabbar{display:flex;gap:8px;flex-wrap:wrap;margin:24px 0 20px}
 .tab-btn{padding:10px 18px;border-radius:999px;border:1px solid #2f3541;background:#111827;color:#e5e7eb;font-weight:600;cursor:pointer;transition:background .15s ease,border-color .15s ease,box-shadow .15s ease}
 .tab-btn.active{background:#2563eb;border-color:#2563eb;box-shadow:0 6px 18px rgba(37,99,235,.35)}
 .tab-panel{display:none}
 .tab-panel.active{display:block}
 .switch{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0}
 .form-actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
 .form-actions .btn{min-width:120px;justify-content:center;text-align:center}
 .pill{width:12px;height:12px;border-radius:999px;background:#1f2937;border:1px solid #374151}
 .pill.ok{background:#22c55e;border-color:#16a34a}
 .pill.err{background:#ef4444;border-color:#b91c1c}
 .pill.off{background:#374151;border-color:#4b5563}
 .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
 .ok{background:#065f46;color:#d1fae5}
 .err{background:#991b1b;color:#fee2e2}
 .warn{background:#92400e;color:#fef3c7}
 small{color:#9ca3af}
 .muted{color:#9ca3af}
 .small{font-size:12px}
 .led-bank{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;margin-top:12px}
 .led-bank.split{flex-direction:column;gap:16px}
 .led-row{display:flex;gap:18px;flex-wrap:wrap;align-items:center}
 .led{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:70px}
 .led-label{font-size:12px;color:#9ca3af;text-align:center;word-break:break-word}
 .led-bulb{width:28px;height:28px;border-radius:50%;position:relative;box-shadow:inset 0 0 6px rgba(0,0,0,.65);background:#1f2937;transition:box-shadow .2s ease,opacity .2s ease}
 .led-bulb::after{content:"";position:absolute;inset:3px;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.35),rgba(255,255,255,0));opacity:0;transition:opacity .2s ease}
 .led-bulb.green{background:#064e3b}
 .led-bulb.red{background:#7f1d1d}
 .led-bulb.on{opacity:1;box-shadow:0 0 14px rgba(96,165,250,.35),inset 0 0 6px rgba(0,0,0,.65)}
 .led-bulb.green.on{background:#16a34a;box-shadow:0 0 16px rgba(16,185,129,.55),inset 0 0 6px rgba(0,0,0,.5)}
 .led-bulb.red.on{background:#dc2626;box-shadow:0 0 16px rgba(220,38,38,.6),inset 0 0 6px rgba(0,0,0,.5)}
 .led-bulb.on::after{opacity:1}
 details.section{border:1px solid #2f3541;border-radius:12px;margin-bottom:12px;overflow:hidden;background:#0f141d}
 details.section > summary{cursor:pointer;padding:12px 14px;background:#101826;font-weight:600;border-bottom:1px solid #2f3541;list-style:none}
 details.section[open] > summary{background:#142033}
 details.section > .inner{padding:14px}
 .fxgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:18px;align-items:start}
 .fxgrid > div{display:flex;flex-direction:column;gap:6px;padding:14px;border-radius:12px;background:#0f141d;border:1px solid #2b3140}
 .fxgrid > .cbrow{flex-direction:row;align-items:center;gap:10px;margin-top:0;padding:14px}
 .fxgrid > .cbrow label{margin:0}
 .fixture-card{border:1px solid #2f3541;border-radius:12px;padding:16px;background:#101826;display:flex;flex-direction:column;gap:8px}
 .fixture-card details{background:#0f141d;border-radius:10px;border:1px solid #2b3140;padding:0}
 .fixture-card details > summary{padding:10px 14px;cursor:pointer;font-weight:600}
 .fixture-card details[open] > summary{background:#142033}
 .fixture-card details > .fxgrid{padding:16px}
 .fixture-card details > .form-actions{padding:0 16px 16px}
 #fixture-list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
 .subcard{border:1px solid #2b3140;border-radius:12px;padding:18px;background:#0f141d;margin-top:20px}
 #import-area{margin-top:16px}
 #logs{min-height:240px}
 .virtual-layout{display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start;margin-top:16px}
 .virtual-pad{flex:0 0 auto}
 .virtual-controls{flex:1 1 240px;display:flex;flex-direction:column;gap:12px}
 /* XY pad */
 #pad{user-select:none;-webkit-user-select:none;touch-action:none;cursor:crosshair}
</style>
</head>
<body>
  <h1>Fly My Fixtures</h1>
  <p>
    <span class="switch"><span>Status:</span><span id="status-pill" class="pill off"></span><small id="status-text">Idle</small></span>
    <span class="switch"><span>Health:</span><span id="health-pill" class="pill off"></span><small id="health-text">Unknown</small></span>
  </p>

  <div class="tabbar" role="tablist">
    <button type="button" class="tab-btn active" data-tab="dashboard">Dashboard</button>
    <button type="button" class="tab-btn" data-tab="settings">Settings</button>
  </div>

  <section class="tab-panel active" data-tab="dashboard">
    <div class="panel-grid">
      <div class="card wide">
        <h3>Controls</h3>
        <div class="switch">
          <button class="btn primary" onclick="activate()">Activate</button>
          <button class="btn danger" onclick="release()">Release</button>
        </div>
        <p class="small muted">Joystick: <span id="joy-name">-</span> • Axes: <span id="joy-axes">0</span> • Buttons: <span id="joy-buttons">0</span></p>
        <p class="small muted">Last frame: <span id="last-frame">-</span></p>
      </div>

      <div class="card wide">
        <h3>Virtual LEDs</h3>
        <div class="led-bank split">
          <div class="led-row">
            <div class="led">
              <div class="led-bulb green" id="led-power"></div>
              <span class="led-label">Power</span>
            </div>
            <div class="led">
              <div class="led-bulb red" id="led-error"></div>
              <span class="led-label">Error</span>
            </div>
          </div>
          <div class="led-row" id="fixture-led-bank">
            <div class="led" data-index="0">
              <div class="led-bulb red" id="fx-led-0"></div>
              <span class="led-label" id="fx-label-0">Slot 1</span>
            </div>
            <div class="led" data-index="1">
              <div class="led-bulb red" id="fx-led-1"></div>
              <span class="led-label" id="fx-label-1">Slot 2</span>
            </div>
            <div class="led" data-index="2">
              <div class="led-bulb red" id="fx-led-2"></div>
              <span class="led-label" id="fx-label-2">Slot 3</span>
            </div>
            <div class="led" data-index="3">
              <div class="led-bulb red" id="fx-led-3"></div>
              <span class="led-label" id="fx-label-3">Slot 4</span>
            </div>
            <div class="led" data-index="4">
              <div class="led-bulb red" id="fx-led-4"></div>
              <span class="led-label" id="fx-label-4">Slot 5</span>
            </div>
            <div class="led" data-index="5">
              <div class="led-bulb red" id="fx-led-5"></div>
              <span class="led-label" id="fx-label-5">Slot 6</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card wide">
        <h3>Virtual HOTAS</h3>
        <div class="switch">
          <label for="vjoy-en">Enable</label>
          <input type="checkbox" id="vjoy-en" onchange="vjoyEnable(this.checked)">
          <small class="muted">Use this when hardware isn’t connected</small>
        </div>

        <div class="virtual-layout">
          <div class="virtual-pad">
            <div id="pad" style="position:relative;width:220px;height:220px;border:1px solid #374151;border-radius:12px;background:radial-gradient(circle at center, #1a1d25, #0f141e);">
              <div id="pad-dot" style="position:absolute;width:18px;height:18px;border-radius:999px;border:2px solid #60a5fa;transform:translate(-50%,-50%);left:110px;top:110px;background:#0f1115"></div>
            </div>
            <div class="switch" style="justify-content:space-between;margin-top:6px">
              <small class="muted">X: <span id="vx">0.00</span>  Y: <span id="vy">0.00</span></small>
            </div>
          </div>

          <div class="virtual-controls">
            <label>Dimmer</label>
            <input type="range" id="vth" min="0" max="100" value="0" oninput="vjoyThrottle(this.value)" />
            <small class="muted">When “Virtual Throttle Invert” is True: 0% = full (axis -1), 100% = empty (axis +1)</small>

            <div style="margin-top:12px">
              <label>Zoom Rocker</label>
              <input type="range" id="vzoom" min="-100" max="100" value="0" oninput="vjoyZoom(this.value)" />
              <small class="muted">Center = hold; push ± to adjust zoom (latches when released)</small>
            </div>

            <div style="margin-top:12px">
              <div class="switch" style="gap:8px;flex-wrap:wrap">
                <button class="btn" onpointerdown="vpress(BTN_ACTIVATE)" onpointerup="vrelease(BTN_ACTIVATE)">Activate</button>
                <button class="btn danger" onpointerdown="vpress(BTN_RELEASE)" onpointerup="vrelease(BTN_RELEASE)">Release</button>
                <button class="btn" onpointerdown="vpress(BTN_FLASH10)" onpointerup="vrelease(BTN_FLASH10)">Flash 10%</button>
                <button class="btn" onpointerdown="vpress(BTN_DIMOFF)" onpointerup="vrelease(BTN_DIMOFF)">Blackout</button>
                <button class="btn" onpointerdown="vpress(BTN_FINE)" onpointerup="vrelease(BTN_FINE)">Fine</button>
                <button class="btn" onpointerdown="vpress(BTN_ZOOM)" onpointerup="vrelease(BTN_ZOOM)">Zoom Mod</button>
              </div>
              <small class="muted">If AX Zoom is set, “Zoom Mod” is ignored (rocker controls zoom incrementally).</small>
            </div>
          </div>
        </div>
      </div>

      <div class="card wide">
        <h3>Packet Capture</h3>
        <label for="pcap-interface">Interface</label>
        <select id="pcap-interface" disabled>
          <option value="">Loading…</option>
        </select>
        <small class="muted" id="pcap-interface-hint">Captures UDP 5568 traffic (sACN). Requires tcpdump with sufficient privileges.</small>
        <p class="small muted" id="pcap-no-ifaces" style="display:none;margin-top:4px;">No network adapters detected.</p>
        <div class="switch" style="margin-top:12px">
          <button class="btn" id="pcap-start" onclick="startPacketCapture()">Start Capture</button>
          <button class="btn danger" id="pcap-stop" onclick="stopPacketCapture()" disabled>Stop</button>
          <a class="btn" id="pcap-download" href="#" style="display:none">Download PCAP</a>
        </div>
        <p class="small muted" id="pcap-status">Idle</p>
        <p class="small" id="pcap-error" style="display:none;background:#4c1d1d;color:#fecaca;padding:6px 10px;border-radius:8px;margin-top:4px;"></p>
      </div>

      <div class="card wide">
        <h3>Logs</h3>
        <textarea id="logs" readonly></textarea>
      </div>
    </div>
  </section>

  <section class="tab-panel" data-tab="settings">
    <div class="panel-grid">
      <div class="card wide">
        <h3>Settings</h3>
        <form id="settings-form" onsubmit="saveSettings();return false;">

          <!-- sACN / Output -->
          <details class="section" open>
            <summary>Output (sACN)</summary>
            <div class="inner">
              <div class="grid">
                <div><label>Priority</label><input type="number" name="priority"></div>
                <div><label>FPS</label><input type="number" name="fps"></div>
                <div><label>Default Universe</label><input type="number" name="default_universe"></div>
                <div class="cbrow"><input type="checkbox" id="per_address_priority_enabled" name="per_address_priority_enabled"><label for="per_address_priority_enabled">Enable Per-Address Priority</label></div>
                <small class="muted" style="grid-column:1 / -1;">When enabled, only patched channels use the configured priority. Disable to send a uniform frame priority.</small>
                <div style="grid-column:1 / -1">
                  <label>Network Adapters</label>
                  <div id="sacn-iface-list" class="checklist">
                    <p class="small muted" id="sacn-iface-loading">Loading adapters…</p>
                  </div>
                  <input type="hidden" name="sacn_bind_addresses" id="sacn_bind_addresses">
                  <small class="muted">Select adapters for sACN output. Leave empty to let the OS choose routing.</small>
                </div>
              </div>
            </div>
          </details>

          <!-- Input mapping -->
          <details class="section" open>
            <summary>Input Mapping (Axes &amp; Buttons)</summary>
            <div class="inner">
              <div class="grid">
                <div><label>AX Pan</label><input type="number" name="ax_pan"></div>
                <div><label>AX Tilt</label><input type="number" name="ax_tilt"></div>
                <div><label>AX Throttle</label><input type="number" name="ax_throt"></div>
                <div><label>AX Zoom</label><input type="number" name="ax_zoom" placeholder="-1 to disable"></div>

                <div><label>BTN Activate</label><input type="number" name="btn_activate"></div>
                <div><label>BTN Release</label><input type="number" name="btn_release"></div>
                <div><label>BTN Flash10</label><input type="number" name="btn_flash10"></div>
                <div><label>BTN Dim Off</label><input type="number" name="btn_dim_off"></div>
                <div><label>BTN Fine</label><input type="number" name="btn_fine"></div>
                <div><label>BTN Zoom Mod</label><input type="number" name="btn_zoom_mod"></div>
              </div>
            </div>
          </details>

          <details class="section">
            <summary>Button → Fixture Actions</summary>
            <div class="inner">
              <p class="small muted">Define joystick button mappings (JSON).
              Supported <code>type</code> values: <b>toggle_fixture</b>, <b>enable_fixture</b>, <b>disable_fixture</b>, <b>toggle_group</b>.
              Optional <code>"mode":"hold"</code> for momentary press.</p>

              <textarea name="button_actions" id="button_actions"></textarea>

              <pre style="white-space:pre-wrap;background:#0b1020;border:1px solid #374151;border-radius:8px;padding:8px;margin-top:6px">
Example:
[
  {"button":7, "type":"toggle_fixture", "targets":["Left"]},
  {"button":8, "type":"toggle_fixture", "targets":["Right"]},
  {"button":9, "type":"toggle_group",   "targets":["Left","Right"]},
  {"button":10,"type":"enable_fixture", "targets":["Left","Right"], "mode":"hold"}
]
              </pre>
            </div>
          </details>

          <!-- Motion / Behavior -->
          <details class="section" open>
            <summary>Movement &amp; Behavior</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="invert_pan" name="invert_pan"><label for="invert_pan">Invert Pan</label></div>
                <div class="cbrow"><input type="checkbox" id="invert_tilt" name="invert_tilt"><label for="invert_tilt">Invert Tilt</label></div>
                <div class="cbrow"><input type="checkbox" id="throttle_invert" name="throttle_invert"><label for="throttle_invert">Throttle Invert</label></div>

                <div><label>Deadband</label><input type="text" name="deadband"></div>
                <div><label>Expo</label><input type="text" name="expo"></div>
                <div><label>Speed</label><input type="number" name="speed"></div>

                <div><label>Pan Min</label><input type="number" name="pan_min"></div>
                <div><label>Pan Max</label><input type="number" name="pan_max"></div>
                <div><label>Tilt Min</label><input type="number" name="tilt_min"></div>
                <div><label>Tilt Max</label><input type="number" name="tilt_max"></div>

                <div><label>Fine Divisor</label><input type="number" name="fine_divisor"></div>
                <div><label>Flash10 Level</label><input type="number" name="flash10_level"></div>
              </div>
            </div>
          </details>

          <!-- Zoom Axis -->
          <details class="section">
            <summary>Zoom Axis (Rocker)</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="zoom_invert" name="zoom_invert"><label for="zoom_invert">Zoom Invert</label></div>
                <div><label>Zoom Deadband</label><input type="text" name="zoom_deadband" placeholder="0.0–0.2"></div>
                <div><label>Zoom Expo</label><input type="text" name="zoom_expo" placeholder="0.0–1.0"></div>
                <div><label>Zoom Speed</label><input type="number" name="zoom_speed" placeholder="e.g. 3000"></div>
              </div>
              <small class="muted">If AX Zoom ≥ 0, the rocker adjusts zoom incrementally and the value latches when released. “Zoom Mod” is ignored.</small>
            </div>
          </details>

          <!-- GPIO LEDs -->
          <details class="section">
            <summary>GPIO LEDs (Raspberry Pi)</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="gpio_enabled" name="gpio_enabled"><label for="gpio_enabled">Enable GPIO LEDs</label></div>
                <div><label>GPIO Green Pin</label><input type="number" name="gpio_green_pin"></div>
                <div><label>GPIO Red Pin</label><input type="number" name="gpio_red_pin"></div>
                <div class="cbrow"><input type="checkbox" id="gpio_active_low" name="gpio_active_low"><label for="gpio_active_low">Active Low</label></div>
                <div><label>Fixture LED Pins (max 6)</label><input type="text" name="gpio_fixture_led_pins" placeholder="e.g. 5,6,13,19,26,12"></div>
                <small class="muted" style="grid-column: 1 / -1;">Enter BCM pin numbers, comma-separated. LEDs light when fixtures are enabled.</small>
              </div>
            </div>
          </details>

          <!-- Virtual Joystick -->
          <details class="section">
            <summary>Virtual Joystick</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="virtual_joystick_enabled" name="virtual_joystick_enabled"><label for="virtual_joystick_enabled">Enable Virtual HOTAS</label></div>
                <div class="cbrow"><input type="checkbox" id="virtual_throttle_invert" name="virtual_throttle_invert"><label for="virtual_throttle_invert">Virtual Throttle Invert</label></div>
              </div>
            </div>
          </details>

          <!-- Debug -->
          <details class="section">
            <summary>Debug Logging</summary>
            <div class="inner">
              <div class="grid">
                <div class="cbrow"><input type="checkbox" id="debug_log_sacn" name="debug_log_sacn"><label for="debug_log_sacn">Log sACN Frames</label></div>
                <div class="cbrow"><input type="checkbox" id="debug_controller_buttons" name="debug_controller_buttons"><label for="debug_controller_buttons">Controller Button Debug</label></div>
                <div><label>Debug Interval (ms)</label><input type="number" name="debug_log_interval_ms"></div>
                <div class="cbrow"><input type="checkbox" id="debug_log_only_changes" name="debug_log_only_changes"><label for="debug_log_only_changes">Only Log Changes</label></div>
                <div>
                  <label for="debug_log_mode">Debug Mode</label>
                  <select name="debug_log_mode" id="debug_log_mode">
                    <option value="summary">Summary</option>
                    <option value="nonzero">Nonzero</option>
                    <option value="full">Full</option>
                  </select>
                </div>
                <div><label>Nonzero Limit</label><input type="number" name="debug_log_nonzero_limit"></div>
              </div>
            </div>
          </details>

          <div class="form-actions">
            <button class="btn primary" type="submit">Save Settings</button>
            <button class="btn danger" type="button" id="restart-btn" onclick="restartService(this)">Restart Service</button>
          </div>
        </form>
      </div>

      <div class="card wide">
        <h3>Fixtures</h3>
        <div class="switch">
          <label for="multi-universe">Multi-Universe Mode</label>
          <input type="checkbox" id="multi-universe" onchange="toggleMU()">
          <span class="small muted">When off, all fixtures use Default Universe</span>
        </div>

        <div id="fixture-list"></div>

        <div class="subcard">
          <h4>Add Fixture</h4>
          <form id="fx-form" onsubmit="addFixture();return false;">
            <div class="fxgrid">
              <div><label>ID</label><input type="text" name="id" required></div>
              <div class="cbrow"><input type="checkbox" id="fx_enabled" checked><label for="fx_enabled">Enabled</label></div>
              <div><label>Universe</label><input type="number" name="universe"></div>
              <div><label>Start Addr (info)</label><input type="number" name="start_addr"></div>

              <div><label>Pan Coarse</label><input type="number" name="pan_coarse"></div>
              <div><label>Pan Fine</label><input type="number" name="pan_fine"></div>
              <div><label>Tilt Coarse</label><input type="number" name="tilt_coarse"></div>
              <div><label>Tilt Fine</label><input type="number" name="tilt_fine"></div>

              <div><label>Dimmer</label><input type="number" name="dimmer"></div>
              <div><label>Zoom</label><input type="number" name="zoom"></div>
              <div><label>Zoom Fine</label><input type="number" name="zoom_fine"></div>

              <div><label>Color Temp Channel (DMX 11)</label><input type="number" name="color_temp_channel" value="11"></div>
              <div><label>Color Temp Value</label><input type="number" name="color_temp_value" value="0" min="0" max="255"></div>

              <div><label>Pan Bias</label><input type="number" name="pan_bias" value="0"></div>
              <div><label>Tilt Bias</label><input type="number" name="tilt_bias" value="0"></div>

              <div><label>Status LED (1-6)</label><input type="number" name="status_led" min="0" max="6" placeholder="1-6"></div>
              <div style="grid-column:1/-1"><small class="muted">Leave blank or 0 to disable the status LED mapping.</small></div>

              <div class="cbrow"><input type="checkbox" id="fx_invert_pan"><label for="fx_invert_pan">Invert Pan</label></div>
              <div class="cbrow"><input type="checkbox" id="fx_invert_tilt"><label for="fx_invert_tilt">Invert Tilt</label></div>
            </div>

            <!-- hidden compat fields sent to backend -->
            <input type="hidden" name="enabled" id="fx_enabled_hidden" value="True">
            <input type="hidden" name="invert_pan" id="fx_invert_pan_hidden" value="False">
            <input type="hidden" name="invert_tilt" id="fx_invert_tilt_hidden" value="False">

            <div class="form-actions">
              <p id="fixture-limit-msg" class="small muted" style="margin:0 0 0.5rem 0;"></p>
              <button class="btn primary" type="submit" id="fx-add-btn">Add Fixture</button>
            </div>
          </form>
        </div>

        <div class="subcard">
          <h4>Import &amp; Export</h4>
          <div class="form-actions">
            <a class="btn" href="/api/fixtures/export" target="_blank">Export CSV</a>
            <button class="btn" type="button" onclick="showImport()">Import CSV</button>
          </div>
          <div id="import-area" style="display:none">
            <textarea id="csvtext" placeholder="Paste CSV here..."></textarea>
            <div class="form-actions">
              <button class="btn primary" type="button" onclick="doImport()">Import</button>
              <button class="btn danger" type="button" onclick="hideImport()">Cancel</button>
            </div>
            <p class="small muted">Columns: id,enabled,universe,start_addr,pan_coarse,pan_fine,tilt_coarse,tilt_fine,dimmer,zoom,zoom_fine,color_temp_channel,color_temp_value,invert_pan,invert_tilt,pan_bias,tilt_bias,status_led</p>
          </div>
        </div>
      </div>
    </div>
  </section>

<script>
async function fetchJSON(url, opts){ const r = await fetch(url, opts); const ct = r.headers.get('content-type')||''; if(!r.ok) throw new Error(await r.text()); return ct.includes('application/json') ? await r.json() : await r.text(); }

const TAB_STORAGE_KEY = 'td.activeTab';
const FIXTURE_LIMIT = 6;

let NETWORK_ADAPTERS = null;
let CAPTURE_STATE = null;
let CAPTURE_POLL_TIMER = null;

async function ensureNetworkAdapters(){
  if(Array.isArray(NETWORK_ADAPTERS)) return NETWORK_ADAPTERS;
  try{
    const resp = await fetchJSON('/api/network/adapters');
    NETWORK_ADAPTERS = Array.isArray(resp.adapters) ? resp.adapters : [];
  }catch(e){
    NETWORK_ADAPTERS = [];
    console.error('Failed to load network adapters', e);
  }
  return NETWORK_ADAPTERS;
}

function syncSacnInterfaces(){
  const container = document.getElementById('sacn-iface-list');
  const hidden = document.getElementById('sacn_bind_addresses');
  if(!hidden) return;
  const selected = [];
  if(container){
    container.querySelectorAll('input[type="checkbox"][data-addr]').forEach(cb => {
      if(cb.checked){
        selected.push(cb.dataset.addr);
      }
    });
  }
  hidden.value = JSON.stringify(selected);
}

function renderCaptureInterfaceOptions(selectedIface){
  const select = document.getElementById('pcap-interface');
  const noMsg = document.getElementById('pcap-no-ifaces');
  if(!select){
    if(noMsg) noMsg.style.display = 'none';
    return;
  }
  const adapters = Array.isArray(NETWORK_ADAPTERS) ? NETWORK_ADAPTERS : [];
  const seen = new Set();
  const previous = select.value;
  const target = selectedIface || previous || '';
  select.innerHTML = '';

  if(!adapters.length){
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No adapters available';
    select.appendChild(opt);
    select.value = '';
    select.disabled = true;
    if(noMsg) noMsg.style.display = 'block';
    return;
  }

  if(noMsg) noMsg.style.display = 'none';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'Select interface…';
  select.appendChild(placeholder);

  adapters.forEach(adapter => {
    const name = adapter && adapter.name ? String(adapter.name) : '';
    if(!name || seen.has(name)) return;
    seen.add(name);
    const option = document.createElement('option');
    option.value = name;
    option.textContent = adapter.address ? `${name} – ${adapter.address}` : name;
    select.appendChild(option);
  });

  if(target && seen.has(target)){
    select.value = target;
  }else{
    select.value = '';
  }
  select.disabled = false;
}

function renderNetworkAdapters(selected){
  const container = document.getElementById('sacn-iface-list');
  const hidden = document.getElementById('sacn_bind_addresses');
  if(!container){
    if(hidden) hidden.value = JSON.stringify(selected || []);
    return;
  }
  const adapters = Array.isArray(NETWORK_ADAPTERS) ? NETWORK_ADAPTERS : [];
  const selectedSet = new Set((selected || []).map(v => String(v)));
  container.innerHTML = '';
  if(!adapters.length){
    const msg = document.createElement('p');
    msg.className = 'small muted';
    msg.textContent = 'No network adapters detected.';
    container.appendChild(msg);
  }else{
    adapters.forEach((adapter, idx) => {
      const id = `iface-${idx}`;
      const wrapper = document.createElement('label');
      wrapper.className = 'checklist-option';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.id = id;
      cb.dataset.addr = adapter.address;
      cb.checked = selectedSet.has(String(adapter.address));
      wrapper.appendChild(cb);
      const textWrap = document.createElement('div');
      textWrap.className = 'checklist-text';
      const title = document.createElement('div');
      title.className = 'checklist-title';
      title.textContent = adapter.label || `${adapter.name} – ${adapter.address}`;
      textWrap.appendChild(title);
      if(adapter.description){
        const desc = document.createElement('small');
        desc.className = 'muted';
        desc.textContent = adapter.description;
        textWrap.appendChild(desc);
      }else if(adapter.is_loopback){
        const note = document.createElement('small');
        note.className = 'muted';
        note.textContent = 'Loopback';
        textWrap.appendChild(note);
      }
      wrapper.appendChild(textWrap);
      container.appendChild(wrapper);
    });
  }
  if(!container.dataset.bound){
    container.addEventListener('change', syncSacnInterfaces);
    container.dataset.bound = 'true';
  }
  syncSacnInterfaces();
  renderCaptureInterfaceOptions(CAPTURE_STATE && CAPTURE_STATE.interface ? CAPTURE_STATE.interface : '');
}

async function refreshNetworkAdapters(selected){
  await ensureNetworkAdapters();
  renderNetworkAdapters(selected);
}

function formatBytes(bytes){
  const value = Number(bytes);
  if(!Number.isFinite(value) || value <= 0){
    return '0 B';
  }
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  let val = value;
  let idx = 0;
  while(val >= 1024 && idx < units.length - 1){
    val /= 1024;
    idx += 1;
  }
  const decimals = val >= 10 || idx === 0 ? 0 : 1;
  return `${val.toFixed(decimals)} ${units[idx]}`;
}

function formatDuration(seconds){
  const total = Math.max(0, Number(seconds) || 0);
  if(total >= 3600){
    const hours = Math.floor(total / 3600);
    const mins = Math.floor((total % 3600) / 60);
    return `${hours}h ${mins}m`;
  }
  if(total >= 60){
    const mins = Math.floor(total / 60);
    const secs = Math.floor(total % 60);
    return `${mins}m ${secs}s`;
  }
  return `${Math.floor(total)}s`;
}

function showCaptureError(message){
  const el = document.getElementById('pcap-error');
  if(!el) return;
  if(message){
    el.textContent = message;
    el.style.display = 'block';
  }else{
    el.textContent = '';
    el.style.display = 'none';
  }
}

function parseErrorMessage(err){
  if(!err) return 'Unexpected error';
  if(typeof err === 'string') return err;
  if(err.error) return err.error;
  if(err.message){
    try{
      const data = JSON.parse(err.message);
      if(data && data.error) return data.error;
    }catch(_){ }
    return err.message;
  }
  return String(err);
}

function updateCaptureUI(state){
  CAPTURE_STATE = state || {};
  const select = document.getElementById('pcap-interface');
  const startBtn = document.getElementById('pcap-start');
  const stopBtn = document.getElementById('pcap-stop');
  const statusEl = document.getElementById('pcap-status');
  const downloadLink = document.getElementById('pcap-download');
  const adapters = Array.isArray(NETWORK_ADAPTERS) ? NETWORK_ADAPTERS : [];
  renderCaptureInterfaceOptions(CAPTURE_STATE.interface || '');

  const active = !!CAPTURE_STATE.active;
  const iface = CAPTURE_STATE.interface || (select ? select.value : '');
  const size = Number(CAPTURE_STATE.filesize || 0);

  if(select){
    const hasAdapters = adapters.length > 0;
    if(iface && hasAdapters && !select.value){
      select.value = iface;
    }
    select.disabled = active || !hasAdapters;
  }

  if(startBtn){
    const ready = select && select.value;
    startBtn.disabled = active || !ready;
  }

  if(stopBtn){
    stopBtn.disabled = !active;
  }

  if(downloadLink){
    if(CAPTURE_STATE.download_ready){
      downloadLink.style.display = 'inline-block';
      downloadLink.href = `/api/capture/download?ts=${Date.now()}`;
    }else{
      downloadLink.style.display = 'none';
      downloadLink.href = '#';
    }
  }

  if(statusEl){
    let text = 'Idle';
    if(active){
      text = `Capturing on ${iface || 'selected interface'}`;
      if(CAPTURE_STATE.started_at){
        try{
          const started = new Date(CAPTURE_STATE.started_at);
          const seconds = (Date.now() - started.getTime()) / 1000;
          text += ` • ${formatDuration(seconds)}`;
        }catch(_){ }
      }
      if(size > 0){
        text += ` • ${formatBytes(size)}`;
      }
    }else if(CAPTURE_STATE.download_ready){
      text = `Capture ready (${formatBytes(size)})`;
      if(iface) text += ` from ${iface}`;
    }else if(iface){
      text = `Last capture on ${iface}`;
    }
    statusEl.textContent = text;
  }

  if(CAPTURE_STATE.error){
    showCaptureError(CAPTURE_STATE.error);
  }else{
    showCaptureError('');
  }
}

async function refreshCaptureState(){
  try{
    await ensureNetworkAdapters();
    const state = await fetchJSON('/api/capture/status');
    updateCaptureUI(state);
  }catch(err){
    console.error('Failed to refresh capture state', err);
  }
}

async function startPacketCapture(){
  const select = document.getElementById('pcap-interface');
  const startBtn = document.getElementById('pcap-start');
  if(!select || !select.value){
    showCaptureError('Select an interface before starting a capture.');
    if(startBtn) startBtn.disabled = false;
    return;
  }
  showCaptureError('');
  if(startBtn) startBtn.disabled = true;
  try{
    const state = await fetchJSON('/api/capture/start', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ interface: select.value })
    });
    updateCaptureUI(state);
  }catch(err){
    const message = parseErrorMessage(err);
    const state = Object.assign({}, CAPTURE_STATE || {});
    state.error = message;
    updateCaptureUI(state);
  }finally{
    if(startBtn){
      const ready = select && select.value;
      const active = CAPTURE_STATE && CAPTURE_STATE.active;
      startBtn.disabled = !!active || !ready;
    }
  }
}

async function stopPacketCapture(){
  const stopBtn = document.getElementById('pcap-stop');
  if(stopBtn) stopBtn.disabled = true;
  try{
    const state = await fetchJSON('/api/capture/stop', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    updateCaptureUI(state);
  }catch(err){
    const message = parseErrorMessage(err);
    const state = Object.assign({}, CAPTURE_STATE || {});
    state.error = message;
    updateCaptureUI(state);
  }finally{
    if(stopBtn){
      const active = CAPTURE_STATE && CAPTURE_STATE.active;
      stopBtn.disabled = !active;
    }
  }
}

function setActiveTab(tab){
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.toggle('active', panel.dataset.tab === tab);
  });
  try{ localStorage.setItem(TAB_STORAGE_KEY, tab); }catch(_){ }
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
});

(function initTab(){
  let initial = 'dashboard';
  try{
    const stored = localStorage.getItem(TAB_STORAGE_KEY);
    if(stored && document.querySelector(`.tab-btn[data-tab="${stored}"]`)){
      initial = stored;
    }
  }catch(_){ }
  setActiveTab(initial);
})();

function setPill(id, ok, off=false){
  const el = document.getElementById(id);
  el.className = 'pill ' + (off ? 'off' : (ok ? 'ok' : 'err'));
}

function setLed(id, on){
  const el = document.getElementById(id);
  if(!el) return;
  if(on){
    el.classList.add('on');
  }else{
    el.classList.remove('on');
  }
}

function updateFixtureLeds(list){
  const rows = document.querySelectorAll('#fixture-led-bank .led');
  rows.forEach((row, idx) => {
    const data = Array.isArray(list) ? list[idx] : null;
    const bulb = row.querySelector('.led-bulb');
    const label = row.querySelector('.led-label');
    const on = data && !!data.on;
    if(bulb){ bulb.classList.toggle('on', on); }
    if(label){ label.textContent = data && data.label ? data.label : `Slot ${idx+1}`; }
  });
}

async function refresh(){
  try{
    const s = await fetchJSON('/api/status');
    document.getElementById('joy-name').innerText = s.joystick_name || (s.virtual ? 'Virtual HOTAS' : '-');
    document.getElementById('joy-axes').innerText = s.axes;
    document.getElementById('joy-buttons').innerText = s.buttons;
    document.getElementById('last-frame').innerText = s.last_frame || '-';

    setPill('status-pill', s.active, !s.active);
    document.getElementById('status-text').innerText = s.active ? 'Active' : 'Idle';

    setPill('health-pill', !s.error, s.joystick_name=='' && !s.error);
    document.getElementById('health-text').innerText = s.error ? ('Error: ' + s.error_msg) : 'Good';

    setLed('led-power', !!s.power_led);
    setLed('led-error', !!s.error_led);
    updateFixtureLeds(s.fixture_leds || []);

    const l = await fetch('/api/logs'); const t = await l.text();
    const ta = document.getElementById('logs'); ta.value = t; ta.scrollTop = ta.scrollHeight;
  }catch(e){ console.error(e); }
}

/* ---------- Settings load/save with checkboxes ---------- */
function isCheckbox(el){ return el && el.type === 'checkbox'; }

async function loadSettings(){
  const data = await fetchJSON('/api/settings');
  const form = document.getElementById('settings-form');
  for(const k in data){
    if(!form[k]) continue;
    const el = form[k];
    if(isCheckbox(el)){
      el.checked = !!data[k];
    }else{
      if(Array.isArray(data[k])){
        el.value = data[k].join(', ');
      }else{
        el.value = data[k];
        if(el.tagName === 'SELECT'){
          const target = String(data[k] ?? '');
          let matched = false;
          for(const opt of el.options){
            if(opt.value === target){
              matched = true;
              break;
            }
          }
          if(!matched && el.options.length){
            el.value = el.options[0].value;
          }
        }
      }
    }
  }
  const sacnSelected = Array.isArray(data.sacn_bind_addresses) ? data.sacn_bind_addresses : [];
  await refreshNetworkAdapters(sacnSelected);
  const sacnHidden = document.getElementById('sacn_bind_addresses');
  if(sacnHidden){
    sacnHidden.value = JSON.stringify(sacnSelected);
  }
  if(form["button_actions"]){
    try{
      form["button_actions"].value = JSON.stringify(data.button_actions || [], null, 2);
    }catch{
      form["button_actions"].value = "[]";
    }
  }
  // sync virtual throttle invert flag into the slider
  const inv = !!data.virtual_throttle_invert;
  const th = document.getElementById('vth');
  if(th) th.dataset.invert = String(inv);
}

async function saveSettings(){
  // for fixtures "add", mirror the visible checkboxes into compat text fields
  syncFixtureCompat();
  syncSacnInterfaces();

  const form = document.getElementById('settings-form');
  const data = {};
  for(const el of form.elements){
    if(!el.name) continue;
    data[el.name] = isCheckbox(el) ? el.checked : el.value;
  }
  if('gpio_fixture_led_pins' in data){
    const pins = String(data.gpio_fixture_led_pins || '')
      .split(',')
      .map(p => p.trim())
      .filter(p => p.length)
      .map(p => Number(p))
      .filter(p => Number.isInteger(p));
    data.gpio_fixture_led_pins = pins;
  }
  if(typeof data.sacn_bind_addresses === 'string'){
    try{
      const parsed = JSON.parse(data.sacn_bind_addresses);
      data.sacn_bind_addresses = Array.isArray(parsed) ? parsed : [];
    }catch{
      data.sacn_bind_addresses = [];
    }
  }
  const resp = await fetchJSON('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  alert((resp && resp.message) || 'Saved');
  loadFixtures();
  readBtnIndicesFromForm();
  await loadSettings(); // refresh slider invert flag
}

/* ---------- Restart service (two-step confirm) ---------- */
let restartConfirmTimer = null;

async function restartService(btn){
  if(!btn) return;
  if(btn.dataset.confirm === 'true'){
    btn.disabled = true;
    btn.textContent = 'Restarting...';
    btn.classList.add('danger');
    clearTimeout(restartConfirmTimer);
    restartConfirmTimer = null;
    try{
      const resp = await fetchJSON('/api/restart', {method:'POST'});
      alert((resp && resp.message) || 'Restarting service...');
    }catch(e){
      alert(e.message || e);
      btn.disabled = false;
      btn.textContent = 'Restart Service';
      btn.classList.add('danger');
      btn.dataset.confirm = '';
      return;
    }
    // don't reset text; service will restart shortly
    return;
  }
  btn.dataset.confirm = 'true';
  btn.textContent = 'Click again to confirm';
  btn.classList.add('danger');
  clearTimeout(restartConfirmTimer);
  restartConfirmTimer = setTimeout(() => {
    btn.dataset.confirm = '';
    btn.textContent = 'Restart Service';
    btn.disabled = false;
  }, 5000);
}

/* ---------- Fixtures helper to mirror checkboxes into compat fields ---------- */
function syncFixtureCompat(){
  const on = document.getElementById('fx_enabled').checked;
  const invP = document.getElementById('fx_invert_pan').checked;
  const invT = document.getElementById('fx_invert_tilt').checked;
  document.getElementById('fx_enabled_hidden').value = on ? 'True' : 'False';
  document.getElementById('fx_invert_pan_hidden').value = invP ? 'True' : 'False';
  document.getElementById('fx_invert_tilt_hidden').value = invT ? 'True' : 'False';
}


/* ---------- Existing endpoints ---------- */
async function activate(){ await fetchJSON('/api/activate', {method:'POST'}); }
async function release(){ await fetchJSON('/api/release', {method:'POST'}); }

function showImport(){ document.getElementById('import-area').style.display='block'; }
function hideImport(){ document.getElementById('import-area').style.display='none'; }
async function doImport(){
  const csv = document.getElementById('csvtext').value;
  try{
    await fetchJSON('/api/fixtures/import', {method:'POST', headers:{'Content-Type':'text/plain'}, body: csv});
    hideImport(); loadFixtures();
  }catch(e){
    alert(e.message || e);
  }
}

async function loadFixtures(){
  const data = await fetchJSON('/api/fixtures');
  document.getElementById('multi-universe').checked = !!data.multi_universe_enabled;
  const form = document.getElementById('fx-form');
  const addBtn = document.getElementById('fx-add-btn');
  const limitMsg = document.getElementById('fixture-limit-msg');
  const count = data.fixtures.length;
  const remaining = Math.max(0, FIXTURE_LIMIT - count);
  if(form){ form.dataset.remaining = String(remaining); }
  if(addBtn){ addBtn.disabled = remaining <= 0; }
  if(limitMsg){
    if(remaining <= 0){
      limitMsg.textContent = `Fixture limit reached (${FIXTURE_LIMIT}). Delete one to add another.`;
    }else if(remaining === 1){
      limitMsg.textContent = 'You can add 1 more fixture.';
    }else{
      limitMsg.textContent = `You can add ${remaining} more fixtures.`;
    }
  }
  const wrap = document.getElementById('fixture-list');
  wrap.innerHTML = '';
  if(!count){ wrap.innerHTML = '<small>No fixtures yet.</small>'; return; }
  for(const f of data.fixtures.slice(0, FIXTURE_LIMIT)){
    const card = document.createElement('div');
    card.className = 'fixture-card';
    card.innerHTML = `
      <div><b>${f.id}</b> ${f.enabled ? '<span class="badge ok">Enabled</span>' : '<span class="badge warn">Disabled</span>'}</div>
      <div class="small muted">Uni ${f.universe} • Pan ${f.pan_coarse}/${f.pan_fine||0} • Tilt ${f.tilt_coarse}/${f.tilt_fine||0} • Dim ${f.dimmer||0} • Zoom ${f.zoom||0}${f.zoom_fine?('/'+f.zoom_fine):''}${colorTempSummary(f)}</div>
      <div class="small muted">Invert P:${f.invert_pan? 'Y':'N'} T:${f.invert_tilt? 'Y':'N'} • Bias P:${f.pan_bias||0} T:${f.tilt_bias||0}${statusLedSummary(f)}</div>
      <details class="fixture-details">
        <summary>Edit</summary>
        <div class="fxgrid">
          ${editInput('Enabled','enabled',f.enabled)}
          ${editInput('Universe','universe',f.universe,'number')}
          ${editInput('Start Addr','start_addr',f.start_addr,'number')}
          ${editInput('Pan Coarse','pan_coarse',f.pan_coarse,'number')}
          ${editInput('Pan Fine','pan_fine',f.pan_fine,'number')}
          ${editInput('Tilt Coarse','tilt_coarse',f.tilt_coarse,'number')}
          ${editInput('Tilt Fine','tilt_fine',f.tilt_fine,'number')}
          ${editInput('Dimmer','dimmer',f.dimmer,'number')}
          ${editInput('Zoom','zoom',f.zoom,'number')}
          ${editInput('Zoom Fine','zoom_fine',f.zoom_fine,'number')}
          ${editInput('Color Temp Ch','color_temp_channel',f.color_temp_channel,'number')}
          ${editInput('Color Temp Val','color_temp_value',f.color_temp_value,'number')}
          ${editInput('Invert Pan','invert_pan',f.invert_pan)}
          ${editInput('Invert Tilt','invert_tilt',f.invert_tilt)}
          ${editInput('Pan Bias','pan_bias',f.pan_bias,'number')}
          ${editInput('Tilt Bias','tilt_bias',f.tilt_bias,'number')}
          ${editInput('Status LED','status_led',f.status_led,'number')}
        </div>
        <div class="form-actions">
          <button class="btn primary" onclick="saveFixture('${f.id}', this.closest('.form-actions').previousElementSibling)">Save</button>
          <button class="btn" onclick="toggleFixture('${f.id}', ${!f.enabled})">${f.enabled?'Disable':'Enable'}</button>
          <button class="btn danger" onclick="deleteFixture('${f.id}')">Delete</button>
        </div>
      </details>`;
    wrap.appendChild(card);
  }
}

function editInput(label, name, value, type){
  if(type==='number'){
    return `<div><label>${label}</label><input type="number" name="${name}" value="${value??''}"></div>`;
  }
  const raw = value === undefined || value === null ? '' : String(value);
  const rawLower = raw.toLowerCase();
  const boolish = (typeof value === 'boolean') || ['true','false','1','0','yes','no','on','off',''].includes(rawLower);
  if(boolish){
    const truthy = ['1','true','yes','on'];
    const boolVal = (typeof value === 'boolean') ? value : truthy.includes(rawLower);
    return `<div><label>${label}</label><select name="${name}"><option value="True"${boolVal?' selected':''}>True</option><option value="False"${!boolVal?' selected':''}>False</option></select></div>`;
  }
  return `<div><label>${label}</label><input type="text" name="${name}" value="${raw}"></div>`;
}

function colorTempSummary(f){
  const chan = Number(f.color_temp_channel || 0);
  if(chan > 0){
    const valRaw = f.color_temp_value;
    const val = (valRaw === undefined || valRaw === null || valRaw === '') ? '' : `=${valRaw}`;
    return ` • Color Temp ${chan}${val}`;
  }
  return '';
}

function statusLedSummary(f){
  const led = Number(f.status_led || 0);
  if(led > 0){
    return ` • Status LED #${led}`;
  }
  return '';
}

async function toggleFixture(id, enabled){
  await fetchJSON('/api/fixtures/'+encodeURIComponent(id), {
    method:'PATCH', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({enabled})
  });
  loadFixtures();
}

async function deleteFixture(id){
  if(!confirm('Delete fixture '+id+'?')) return;
  await fetchJSON('/api/fixtures/'+encodeURIComponent(id), {method:'DELETE'});
  loadFixtures();
}

async function saveFixture(id, gridEl){
  const fields = {};
  for(const el of gridEl.querySelectorAll('input, select')){
    fields[el.name] = el.value;
  }
  await fetchJSON('/api/fixtures/'+encodeURIComponent(id), {
    method:'PATCH', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(fields)
  });
  loadFixtures();
}

async function addFixture(){
  const form = document.getElementById('fx-form');
  const remaining = Number(form?.dataset?.remaining || '0');
  if(remaining <= 0){
    alert(`Fixture limit of ${FIXTURE_LIMIT} reached. Delete a fixture before adding another.`);
    return;
  }
  syncFixtureCompat();
  const data = {};
  for(const el of form.elements){ if(el.name) data[el.name]=el.value; }
  try{
    await fetchJSON('/api/fixtures', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  }catch(e){
    alert(e.message || e);
    return;
  }
  form.reset();
  // reset compat defaults
  document.getElementById('fx_enabled').checked = true;
  document.getElementById('fx_invert_pan').checked = false;
  document.getElementById('fx_invert_tilt').checked = false;
  if(form.enabled) form.enabled.value = 'True';
  if(form.invert_pan) form.invert_pan.value = 'False';
  if(form.invert_tilt) form.invert_tilt.value = 'False';
  if(form.status_led) form.status_led.value = '';
  loadFixtures();
}

async function toggleMU(){
  const checked = document.getElementById('multi-universe').checked;
  await fetchJSON('/api/fixtures/config', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({multi_universe_enabled: checked})});
  loadFixtures();
}

/* -------- Virtual HOTAS JS -------- */
let BTN_ACTIVATE, BTN_RELEASE, BTN_FLASH10, BTN_DIMOFF, BTN_FINE, BTN_ZOOM;
function readBtnIndicesFromForm(){
  const f = document.getElementById('settings-form');
  const g = k => f && f[k] ? parseInt(f[k].value||'0') : 0;
  BTN_ACTIVATE = g('btn_activate');
  BTN_RELEASE  = g('btn_release');
  BTN_FLASH10  = g('btn_flash10');
  BTN_DIMOFF   = g('btn_dim_off');
  BTN_FINE     = g('btn_fine');
  BTN_ZOOM     = g('btn_zoom_mod');
}

async function vjoySyncEnabled(){
  const s = await fetchJSON('/api/virtual');
  document.getElementById('vjoy-en').checked = !!s.enabled;
  setPadDot(s.x, s.y);
  document.getElementById('vx').innerText = Number(s.x).toFixed(2);
  document.getElementById('vy').innerText = Number(s.y).toFixed(2);
  const sv = Math.round((s.throttle + 1) * 50); // -1..1 → 0..100 display
  const th = document.getElementById('vth'); if(th) th.value = sv;
  const vz = document.getElementById('vzoom'); if(vz) vz.value = Math.round((s.zaxis || 0)*100);
}

async function vjoyEnable(on){
  await fetchJSON('/api/virtual', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({enabled:on})});
}

function setPadDot(x, y){
  const pad = document.getElementById('pad');
  const dot = document.getElementById('pad-dot');
  const w = pad.clientWidth, h = pad.clientHeight;
  const cx = (x*0.5 + 0.5) * w;
  const cy = (1 - (y*0.5 + 0.5)) * h;
  dot.style.left = cx + 'px';
  dot.style.top  = cy + 'px';
}

function padSend(x, y){
  document.getElementById('vx').innerText = x.toFixed(2);
  document.getElementById('vy').innerText = y.toFixed(2);
  fetch('/api/virtual', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({x,y})
  }).catch(()=>{});
}

function padPointToXY(ev){
  const pad = document.getElementById('pad');
  const r = pad.getBoundingClientRect();
  const px = Math.max(0, Math.min(r.width,  (ev.clientX - r.left)));
  const py = Math.max(0, Math.min(r.height, (ev.clientY - r.top)));
  const x = (px / r.width) * 2 - 1;
  const y = -((py / r.height) * 2 - 1);
  return { x: Math.max(-1, Math.min(1, x)), y: Math.max(-1, Math.min(1, y)) };
}

function padCenter(){
  const x = 0, y = 0;
  setPadDot(x, y);
  padSend(x, y);
}

(function initPad(){
  const pad = document.getElementById('pad');
  if(!pad) return;

  let down = false;
  let pointerId = null;

  pad.addEventListener('pointerdown', ev => {
    ev.preventDefault();
    down = true;
    pointerId = ev.pointerId;
    try{ pad.setPointerCapture(pointerId); }catch(_){}
    const {x, y} = padPointToXY(ev);
    setPadDot(x, y);
    padSend(x, y);
  });

  pad.addEventListener('pointermove', ev => {
    if(!down) return;
    ev.preventDefault();
    const {x, y} = padPointToXY(ev);
    setPadDot(x, y);
    padSend(x, y);
  });

  function end(ev){
    if(!down) return;
    down = false;
    try{ pad.releasePointerCapture(pointerId); }catch(_){}
    pointerId = null;
    padCenter(); // spring to center on release
  }

  pad.addEventListener('pointerup', end);
  pad.addEventListener('pointercancel', end);
  pad.addEventListener('pointerleave', end);

  setPadDot(0, 0);
})();

(() => {
  const zoom = document.getElementById('vzoom');
  if(!zoom) return;

  let engaged = false;
  let pointerId = null;

  const centerZoom = () => {
    if(!engaged) return;
    engaged = false;
    if(pointerId !== null){
      try{ zoom.releasePointerCapture(pointerId); }catch(_){ }
      pointerId = null;
    }
    zoom.value = '0';
    vjoyZoom(0);
  };

  zoom.addEventListener('pointerdown', ev => {
    engaged = true;
    pointerId = ev.pointerId;
    try{ zoom.setPointerCapture(pointerId); }catch(_){ }
  });

  ['pointerup','pointercancel','lostpointercapture'].forEach(evt => {
    zoom.addEventListener(evt, centerZoom);
  });

  zoom.addEventListener('pointerleave', ev => {
    if(!ev.buttons) centerZoom();
  });

  zoom.addEventListener('keydown', () => { engaged = true; });
  zoom.addEventListener('keyup', centerZoom);
  zoom.addEventListener('blur', centerZoom);
})();

// Slider 0..100 → axis -1..1, honoring "virtual_throttle_invert"
function vjoyThrottle(val){
  const inv = document.getElementById('vth').dataset.invert === 'true';
  const v = parseFloat(val);
  const axis = inv ? (v/50 - 1.0) : (1.0 - v/50);
  fetch('/api/virtual', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({throttle: axis})});
}

// Zoom rocker slider: -100..100 → -1..1
function vjoyZoom(val){
  const axis = Math.max(-1, Math.min(1, parseFloat(val)/100));
  fetch('/api/virtual', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ zaxis: axis })});
}

async function vpress(i){ await fetchJSON('/api/virtual/press',   {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({button:i})}); }
async function vrelease(i){ await fetchJSON('/api/virtual/release', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({button:i})}); }

const _orig_loadSettings = loadSettings;
loadSettings = async function(){
  await _orig_loadSettings();
  readBtnIndicesFromForm();
  vjoySyncEnabled();
};

vjoySyncEnabled();
/* ----------------------------------- */

loadSettings();
loadFixtures();
setInterval(refresh, 1000);
refresh();
refreshCaptureState();
if(!CAPTURE_POLL_TIMER){
  CAPTURE_POLL_TIMER = setInterval(refreshCaptureState, 5000);
}
</script>
</body></html>
